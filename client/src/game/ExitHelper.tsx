import { useGameStateStore } from "../stores/useGameStateStore";
import { usePlayerStore } from "../stores/usePlayerStore";
import { useCameraStore } from "../lib/stores/useCameraStore";
import * as THREE from "three";
import { getGardenExitPosition, getMarketExitPosition, getKitchenExitPosition } from "./Buildings";

/**
 * ExitHelper - Componente de ayuda para salir de los edificios
 * 
 * Esta funci칩n manipula directamente el estado del juego y la posici칩n del jugador
 * para asegurar que al salir de un edificio, el jugador aparezca lejos de las puertas
 * y as칤 evitar el ciclo de reentrar autom치ticamente.
 */
export const useExitHelper = () => {
  const exitBuilding = (building: "market" | "kitchen" | "garden") => {
    // 1. Obtener posiciones relevantes
    let exitPosition;
    
    // Ajustamos diferentes distancias para cada edificio para que la vista funcione bien
    if (building === "market") {
      const basePosition = getMarketExitPosition();
      exitPosition = {
        x: basePosition.x,
        y: basePosition.y,
        z: basePosition.z + 4 // Alej치ndose bastante de la puerta
      };
    } 
    else if (building === "kitchen") {
      const basePosition = getKitchenExitPosition();
      exitPosition = {
        x: basePosition.x,
        y: basePosition.y,
        z: basePosition.z + 4 // Alej치ndose bastante de la puerta
      };
    }
    else if (building === "garden") {
      const basePosition = getGardenExitPosition();
      // Para el huerto, usamos una posici칩n m치s retrasada para que se vea el personaje completo
      exitPosition = {
        x: basePosition.x,
        y: basePosition.y,
        z: -5 // Posici칩n fija que mejora la vista de la c치mara
      };
    }
    
    // 2. Cambiar estado del juego a "playing"
    useGameStateStore.setState({ gameState: "playing" });
    
    // 3. Mover al jugador a una posici칩n segura lejos de las puertas
    if (exitPosition) {
      const { setPlayerPosition } = usePlayerStore.getState();
      setPlayerPosition(exitPosition);
      
      // 4. Solicitar reseteo de c치mara para que el componente Player la ajuste
      const { requestReset } = useCameraStore.getState();
      requestReset();
      
      console.log(`游뛁 Saliendo de ${building} con posici칩n segura:`, exitPosition);
    }
  };
  
  return { exitBuilding };
};